{
  "hash": "847a27f28b971c1d9e1c7a04daca0fc6",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Session4\"\nformat: html\nengine: knitr\nwebr: \n  show-startup-message: false    # Disable displaying status of webR initialization\n  packages: ['ggplot2', 'ggpubr','easystats','report','ggbeeswarm'] # Install R packages on document open\nfilters:\n  - webr\n---\n\n\n\n\n```{webr-r}\n#| echo: false\n#| message: false\n#| warning: false\nlibrary(ggplot2)\nlibrary(ggpubr)\nlibrary(report)\nlibrary(ggbeeswarm)\n```\n\n\nSlides for session 4 (analysis) are here: \n\n* [Session 4 slides](gibasession4.pptx)\n\n## Analysis of a blocked randomised study\n\n### Introduction\n\nThe code below simulates a parallel group randomised controlled trial conducted in men and women.\n\nThere were 40 participants in total, 20 men and 20 women.\n\nThere was a blocked randomisation, so that men and women were balanced across groups (10 each per treatment group)\n\nThe blocking was performed because we know that men have typically higher responses than women.\n\n\n```{webr-r}\nlibrary(ggplot2)\nlibrary(ggbeeswarm)\nlibrary(patchwork)\n\n# Define the groups\ntreatment = c(\"Treat\", \"Control\")\nsex = c(\"Male\",\"Female\")\n\n# Here we set up the dataset with 10 copies of each combination of treatment and sex\ndat <- expand.grid( treatment=treatment , sex=sex,rep=1:10)\n\n# True treatment effect = 1\n# True sex effect = 2\n# Normally distributed indidividual variation with sd=1\n\nset.seed(200) # Setting the seed fixes the response\n\n# Now generate the response (y) with the known treatment effect, sex effect and random variation\ndat <- transform(dat, y = 10 + (treatment==\"Treat\") + 2*(sex==\"Male\") + rnorm(nrow(dat)))\n\n```\n\nRemember the experimental design equation for this study is:\n\n`Outcome = Treatment + Sex + Error`\n\nBelow we show why it is important to respect this equation in our analysis phase as well as our design phase.\n\nSince we have a two group study with a continuous outcome, we might be tempted to apply a two-groups t-test to compare the responses:\n\n```{webr-r}\n# The first graph \ngraph1 = ggplot(dat) + \n  aes(x=treatment, y=y) + \n  geom_beeswarm(aes(shape=sex)) + \n  theme_bw()+ \n  stat_summary(geom=\"errorbar\",width=.5,fun.data = \"mean_se\") + \n  scale_y_continuous(limits=c(8,15)) + \n  ggpubr::stat_compare_means(method=\"t.test\",comparisons=list(1:2))  + \n  labs(x=\"Treatment\", y=\"Response\",shape=\"Sex\")\n```\n\nWhile there is some evidence of the difference between groups (that we know is there!), it is not statistically significant.  We have type-2 error in this case (false negative).  This is caused by the high variation within each treatment group overwhelming the signal from the treatment.\n\nBut if we stratify the data by sex, we explain much of that variation.  The signal is much more obvious, and is statistically significant in both groups despite there being half the participants in each!\n\n```{webr-r}\ngraph1 + (graph1 + facet_wrap(~sex) ) + plot_layout(guides=\"collect\")\n```\n\nThe linear model corresponding to the unpaired t-test is given below. Note the residual error in the output and the standard error for the effect of treatment.\n\n```{web-r}\nlm(data=dat , y ~ treatment) |> summary()\n```\n\nNext we'll try the model that corresponds to the design equation.  We have explained far more variance (smaller residual error), and so have a m.\n\n```{web-r}\nlm(data=dat , y ~ treatment + sex) |> summary()\n```\n\nAlthough this dataset was picked to illustrate the point, we can find the power of the study with each analytical approach by replicating the study many times, and finding what proportion of p-values is less than 0.05.\n\n```{webr-r}\n\noneRep <- function(){\n  dat <- transform(dat, y = 10 + (treatment==\"Treat\") + 2*(sex==\"Male\") + rnorm(nrow(dat)))\n  model1_p <- lm(data=dat , y ~ treatment) |> summary() |> coef())[\"treatmentControl\",\"Pr(>|t|)\"]\n  model2_p <- lm(data=dat , y ~ treatment + sex) |> summary() |> coef())[\"treatmentControl\",\"Pr(>|t|)\"]\n  c(model1_p,model2_p)\n}\n\nreplicate(1000,oneRep()) |> t() |> as.data.frame()|> lapply(\\(x) mean(x<0.05))\n\n```\n\nHere, using the design equation to set up the analysis model leads to a much more powerful design, by explaining the variance associated with the identified factors.  It also means that the assumptions underlying the regression model, in particular normal random errors, more likely to be met.\n\n```{web-r}\nlm(data=dat , y ~ treatment + sex) |> report::report_model()\n```\n",
    "supporting": [
      "GIBA-session4_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}